import json
import google.generativeai as genai
import config


def create_conversation_json():
    genai.configure(api_key=config.MAKERSUITE_KEY)

    generation_config = {
        "temperature": 0.9,
        "top_p": 1,
        "top_k": 1,
        "max_output_tokens": 4000,
    }

    safety_settings = [
        {
            "category": "HARM_CATEGORY_HARASSMENT",
            "threshold": "BLOCK_MEDIUM_AND_ABOVE"
        },
        {
            "category": "HARM_CATEGORY_HATE_SPEECH",
            "threshold": "BLOCK_MEDIUM_AND_ABOVE"
        },
        {
            "category": "HARM_CATEGORY_SEXUALLY_EXPLICIT",
            "threshold": "BLOCK_MEDIUM_AND_ABOVE"
        },
        {
            "category": "HARM_CATEGORY_DANGEROUS_CONTENT",
            "threshold": "BLOCK_MEDIUM_AND_ABOVE"
        },
    ]

    model = genai.GenerativeModel(model_name="gemini-pro",
                                  generation_config=generation_config,
                                  safety_settings=safety_settings)

    prompt_parts = [
        "Create a JSON file simulating a iMessage conversation between two people. Decide a relationship between them that can be related to family, school, work, etc, and tell a story through their messages. Make sure there is a serious conflict between the two of them, and make the receiver be the one in the wrong. Make sure to end the conversation with ONLY for a sender \"Delivered\". Show \"Read X:XX\" (X:XX being a time) if the sender is the LAST person to talk in a conversation.\n\nStart of with a time entry or if you'd like to have a large gap in time, create a new entry with just the key 'time' and something like 'Today 5:48pm'\n\nEXAMPLE OUTPUT ONE:\n[\n{\n\"time\": \"Today 7:56pm\"\n},\n{\n\"text\": \"Hey Mr. Carter, got a sec? My paycheck's looking really weird\",\n\"user\": \"sender\",\n\"gender\": \"male\"\n},\n{\n\"text\": \"What's up?\",\n\"user\": \"receiver\",\n\"gender\": \"male\"\n},\n{\n\"text\": \"I only got $120 this week. Usually, it's like $1,200\",\n\"user\": \"sender\",\n\"gender\": \"male\"\n},\n{\n\"text\": \"Do you know what happened? Mistake, maybe?\",\n\"user\": \"sender\",\n\"gender\": \"male\"\n},\n{\n\"text\": \"Nope, it's correct\",\n\"user\": \"receiver\",\n\"gender\": \"male\"\n},\n{\n\"text\": \"How? I've been working extra hours and all...\",\n\"user\": \"sender\",\n\"gender\": \"male\"\n},\n{\n\"text\": \"I thought I was doing good here, I give my 100%\",\n\"user\": \"sender\",\n\"gender\": \"male\"\n},\n{\n\"text\": \"We had to cut costs. Sent an email about it last week.\",\n\"user\": \"receiver\",\n\"gender\": \"male\"\n},\n{\n\"text\": \"Cut costs? But this is super low\",\n\"user\": \"sender\",\n\"gender\": \"male\"\n},\n{\n\"text\": \"I don't remember any email about this\",\n\"user\": \"sender\",\n\"gender\": \"male\"\n},\n{\n\"text\": \"How am I supposed to live off of this?\",\n\"user\": \"sender\",\n\"gender\": \"male\"\n},\n{\n\"text\": \"This is only $480 a month.\",\n\"user\": \"sender\",\n\"gender\": \"male\"\n},\n{\n\"text\": \"Well it seems like your problem that you haven't seen an email\",\n\"user\": \"receiver\",\n\"gender\": \"male\"\n},\n{\n\"text\": \"As I mentioned in email: Your recent work wasn't up to par. You're being disrespectful to our customers and coworkers\",\n\"user\": \"receiver\",\n\"gender\": \"male\"\n},\n{\n\"text\": \"That's not true, I am the nicest to everyone!\",\n\"user\": \"sender\",\n\"gender\": \"male\"\n},\n{\n\"text\": \"As I said, I give my 100% for this job! I even work extra hours!\",\n\"user\": \"sender\",\n\"gender\": \"male\"\n},\n{\n\"text\": \"Management thinks differently\",\n\"user\": \"receiver\",\n\"gender\": \"male\"\n},\n{\n\"text\": \"And what am I supposed to do?\",\n\"user\": \"sender\",\n\"gender\": \"male\"\n},\n{\n\"text\": \"This isn't fair, you can't just leave me with almost nothing.\",\n\"user\": \"sender\",\n\"gender\": \"male\"\n},\n{\n\"text\": \"That's exactly what we've done.\",\n\"user\": \"receiver\",\n\"gender\": \"male\"\n},\n{\n\"text\": \"And you can't do anything about it.\",\n\"user\": \"receiver\",\n\"gender\": \"male\"\n},\n{\n\"text\": \"You can't just change my pay like this!\",\n\"user\": \"sender\",\n\"gender\": \"male\"\n},\n{\n\"text\": \"If you keep demanding an increase in pay, we can just not pay you at all.\",\n\"user\": \"receiver\",\n\"gender\": \"male\"\n},\n{\n\"text\": \"What? You can't do that\",\n\"user\": \"sender\",\n\"gender\": \"male\"\n},\n{\n\"text\": \"Okay, since you won't stop this attitude, you're fired\",\n\"user\": \"receiver\",\n\"gender\": \"male\"\n},\n{\n\"text\": \"What?\",\n\"user\": \"sender\",\n\"gender\": \"male\"\n},\n{\n\"text\": \"You aren't working with us anymore.\",\n\"user\": \"receiver\",\n\"gender\": \"male\"\n},\n{\n\"text\": \"I did nothing wrong, you can't fire me!\",\n\"user\": \"sender\",\n\"gender\": \"male\"\n},\n{\n\"text\": \"You literally cut my pay for no reason, then lied and fired me!\",\n\"user\": \"sender\",\n\"gender\": \"male\"\n},\n{\n\"text\": \"It is our company and we have the executive decision, please stop texting me.\",\n\"user\": \"receiver\",\n\"gender\": \"male\"\n},\n{\n\"text\": \"Okay, you know what?\",\n\"user\": \"sender\",\n\"gender\": \"male\"\n},\n{\n\"text\": \"Fire me then, I can't wait to see what happens to your company\",\n\"user\": \"sender\",\n\"gender\": \"male\"\n},\n{\n\"text\": \"What are you going to do?\",\n\"user\": \"receiver\",\n\"gender\": \"male\"\n},\n{\n\"text\": \"Just wait, you'll see.\",\n\"user\": \"sender\",\n\"gender\": \"male\"\n},\n{\n\"text\": \"Are you threatening us right now?\",\n\"user\": \"receiver\",\n\"gender\": \"male\"\n},\n{\n\"text\": \"I understand you lost your job, but this isn't that serious.\",\n\"user\": \"receiver\",\n\"gender\": \"male\"\n},\n{\n\"text\": \"I'll be contacting my lawyer.\",\n\"user\": \"sender\",\n\"gender\": \"male\"\n},\n{\n\"text\": \"You've made a VERY BIG mistake by doing this :)\",\n\"user\": \"sender\",\n\"gender\": \"male\"\n},\n{\n\"text\": \"Whatever.\",\n\"user\": \"receiver\",\n\"gender\": \"male\"\n},\n{\n\"text\": \"See you in court.\",\n\"user\": \"sender\",\n\"gender\": \"male\",\n\"subtitle\": \"Delivered\"\n}\n]\n\nEXAMPLE OUTPUT TWO: \n[\n{\n\"time\": \"Today 3:20pm\"\n},\n\nï»¿{\n\"text\": \"Have you picked up your son?\",\n\"user\": \"sender\",\n\"gender\": \"female\"\n},\n{\n\"text\": \"Hey, sorry! Long day at work, still here\",\n\"user\": \"receiver\",\n\"gender\": \"female\"\n},\n{\n\"text\": \"Oh, come on Stacy, don't say that, you know how I feel about his dad not being around!\",\n\"user\": \"sender\",\n\"gender\": \"female\"\n},\n{\n\"text\": \"It's past 7 pm, you need to go get him\",\n\"user\": \"sender\",\n\"gender\": \"female\"\n},\n{\n\"text\": \"Look, I'll explain later, I'm still really busy\",\n\"user\": \"receiver\",\n\"gender\": \"female\"\n},\n{\n\"text\": \"I shouldn't even have to tell you that!\",\n\"user\": \"sender\",\n\"gender\": \"female\"\n},\n{\n\"text\": \"I'm going to pick him up, and then we are going to have a long talk young lady\",\n\"user\": \"sender\",\n\"gender\": \"female\"\n},\n{\n\"text\": \"Sorry we can't have dinner together tonight; I'll make it up to you, I promise. Love you\",\n\"user\": \"receiver\",\n\"gender\": \"female\"\n},\n{\n\"text\": \"Love you too, don't let it be too late\",\n\"user\": \"sender\",\n\"gender\": \"female\"\n},\n{\n\"text\": \"Sorry Lily, couldn't make it, fell asleep :(\",\n\"user\": \"receiver\",\n\"gender\": \"female\"\n},\n{\n\"text\": \"I can't believe you fell asleep before coming to get your own son, what's going on Stacy?\",\n\"user\": \"sender\",\n\"gender\": \"female\"\n},\n{\n\"text\": \"Never mind... I'll handle it\",\n\"user\": \"sender\",\n\"gender\": \"female\"\n},\n{\n\"text\": \"I'm doing my best, I'm sorry ok?\",\n\"user\": \"receiver\",\n\"gender\": \"female\"\n},\n{\n\"text\": \"How are you going to pay for his education, Stacy? You're never even there, and always make excuses\",\n\"user\": \"sender\",\n\"gender\": \"female\"\n},\n{\n\"text\": \"I didn't have any choice!\",\n\"user\": \"receiver\",\n\"gender\": \"female\"\n},\n{\n\"text\": \"Oh really? Tell me, what choice did you not have? I'm waiting\",\n\"user\": \"sender\",\n\"gender\": \"female\"\n},\n{\n\"text\": \"Dad isn't paying child support, I don't get paid enough, this job is so tiring\",\n\"user\": \"receiver\",\n\"gender\": \"female\"\n},\n{\n\"text\": \"And whose fault is that? You got pregnant at 22 knowing he wouldn't be around\",\n\"user\": \"sender\",\n\"gender\": \"female\"\n},\n{\n\"text\": \"That doesn't matter right now, the point is I can't support my son!\",\n\"user\": \"receiver\",\n\"gender\": \"female\"\n},\n{\n\"text\": \"So you decided to pick up extra shifts at work, instead of picking up your own son?\",\n\"user\": \"sender\",\n\"gender\": \"female\"\n},\n{\n\"text\": \"Yes, it was the only way I could afford rent and food\",\n\"user\": \"receiver\",\n\"gender\": \"female\"\n},\n{\n\"text\": \"Oh, do you think I don't have to pay bills Stacy? I'm his grandma for crying out loud, I should not be doing this\",\n\"user\": \"sender\",\n\"gender\": \"female\"\n},\n{\n\"text\": \"I know, and I'm sorry, ok? It's just this once, I promise I'll make it up to you\",\n\"user\": \"receiver\",\n\"gender\": \"female\"\n},\n{\n\"text\": \"You better Stacy. You need to make some big changes in your life and fast, or this family is going under\",\n\"user\": \"sender\",\n\"gender\": \"female\"\n\"subtitle\": \"Delivered\"\n},\n{\n\"time\": \"Today 5:48 PM\"\n},\n{\n\"text\": \"I promise, I'm really sorry\",\n\"user\": \"receiver\",\n\"gender\": \"female\"\n}\n]",
    ]

    while True:
        try:
            response = model.generate_content(prompt_parts)
            return json.loads(response.text)
        except Exception as e:
            print(f"Error: {e},\nTrying to generate conversation again...")
